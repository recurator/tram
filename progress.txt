## Codebase Patterns
- Use TypeScript enums with string values for database column values (e.g., Tier.HOT = "HOT")
- Use ISO 8601 date strings for all timestamp fields
- Use JSDoc comments on interfaces and enums to document purpose and half-lives
- JSON arrays stored as strings in SQLite (e.g., use_days)

- Use better-sqlite3 for synchronous SQLite operations with TypeScript
- Enable WAL mode (journal_mode = WAL) for concurrency
- Use INTEGER for boolean columns (do_not_inject, pinned) with 0/1 values
- Foreign key constraints supported but need PRAGMA foreign_keys = ON for enforcement

- FTS5 uses content='' with content_rowid for external content tables (sync via triggers)
- BM25 scores in FTS5 are negative; negate for intuitive ranking (higher = more relevant)
- Cache prepared statements for performance (e.g., searchStmt in FTS5Helper)
- Handle FTS5 query syntax errors by falling back to phrase search with escaped quotes

- @xenova/transformers provides fully offline embedding inference via ONNX runtime
- Cache model pipelines after first load (use initPromise pattern to prevent concurrent initialization)
- Use mean pooling + normalization for sentence embeddings
- Common model dimensions: MiniLM = 384, mpnet/gte-base/e5-base = 768

- OpenAI embedding models: text-embedding-3-small (1536), text-embedding-3-large (3072), text-embedding-ada-002 (1536)
- Use native fetch() for API calls (Node 18+); no additional HTTP library needed
- OpenAI embeddings API may return results out of order; sort by index field
- Provide specific error guidance based on HTTP status (401=auth, 429=rate limit, 400=bad input)

- sqlite-vec uses vec0 virtual table with FLOAT[N] column type for embeddings
- When sqlite-vec unavailable, store embeddings as BLOBs (Float32Array buffer)
- Cosine similarity: dot(a,b) / (||a|| * ||b||), clamp result to [0,1] for floating point safety
- Convert Buffer to Float32Array using buffer.buffer, buffer.byteOffset, buffer.byteLength/4

---

## 2026-01-31 - US-009
- What was implemented: Added hybridSearch function to VectorHelper combining FTS and vector search
- Files changed:
  - extensions/memory-tiered/db/vectors.ts (updated)
- **Learnings for future iterations:**
  - hybridSearch imports FTS5Helper and can accept it via constructor or setFtsHelper() for sharing
  - Hybrid search fetches 3x candidates (min 30) from both sources, then merges
  - BM25 scores normalized to 0-1 by dividing by max score (avoids negative handling)
  - Default weights: vector (0.7), text (0.3) - vector similarity has higher weight
  - Combined score = vectorWeight * vectorScore + textWeight * textScore
  - Results include both component scores for explainability
  - Deduplication via Set of IDs from union of both result sets
---

## 2026-01-31 - US-008
- What was implemented: Created VectorHelper for sqlite-vec vector search with cosine fallback
- Files changed:
  - extensions/memory-tiered/db/vectors.ts (new)
- **Learnings for future iterations:**
  - sqlite-vec extension loaded via db.loadExtension(); try multiple paths (vec0, sqlite-vec)
  - vec0 virtual table: CREATE VIRTUAL TABLE name USING vec0(id TEXT PK, embedding FLOAT[N])
  - sqlite-vec provides vec_distance_cosine() function; convert to similarity with 1 - distance
  - For fallback, store embeddings as Buffers from Float32Array
  - Buffer.from(new Float32Array(embedding).buffer) creates blob for storage
  - VectorSearchResult includes id, text, similarity (0-1 score)
  - Fallback loads all embeddings and computes similarity in-memory (O(n) for each search)
---

## 2026-01-31 - US-007
- What was implemented: Created OpenAIEmbeddingProvider for cloud-based embeddings via OpenAI API
- Files changed:
  - extensions/memory-tiered/embeddings/openai.ts (new)
- **Learnings for future iterations:**
  - OpenAI embeddings API endpoint: https://api.openai.com/v1/embeddings
  - API key required in config; validated in constructor with actionable error message
  - Default model is text-embedding-3-small with 1536 dimensions
  - embedBatch uses the same endpoint with array input for efficiency
  - Response data may be unordered; sort by index before returning
  - Network errors detected via TypeError from fetch; provide connectivity guidance
---

## 2026-01-31 - US-006
- What was implemented: Created LocalEmbeddingProvider using @xenova/transformers for offline embeddings
- Files changed:
  - extensions/memory-tiered/embeddings/local.ts (new)
  - extensions/memory-tiered/package.json (added @xenova/transformers dependency)
  - extensions/memory-tiered/package-lock.json (updated)
- **Learnings for future iterations:**
  - @xenova/transformers includes TypeScript types; no separate @types package needed
  - Use dynamic import for @xenova/transformers to avoid loading at module initialization
  - pipeline("feature-extraction", modelPath) creates embedding pipeline
  - Output needs { pooling: "mean", normalize: true } for sentence embeddings
  - Batch embeddings return flat Float32Array; slice by dimensions for each input
  - Model dimensions map: MODEL_DIMENSIONS[modelPath] for known models
  - Error messages should include actionable guidance (e.g., npm install suggestion)
---

## 2026-01-31 - US-005
- What was implemented: Created EmbeddingProvider interface for embedding abstraction
- Files changed:
  - extensions/memory-tiered/embeddings/provider.ts (new)
- **Learnings for future iterations:**
  - The EmbeddingProvider interface supports both single and batch embedding operations
  - getDimensions() returns the vector size (e.g., 384 for MiniLM, 1536 for OpenAI)
  - getModelName() returns the model identifier for logging/debugging
  - Implementations will need to cache loaded models for performance (US-006)
---

## 2026-01-31 - US-004
- What was implemented: Created FTS5 full-text search integration with BM25 ranking
- Files changed:
  - extensions/memory-tiered/db/fts.ts (new)
- **Learnings for future iterations:**
  - FTS5 virtual table uses `content='memories', content_rowid='rowid'` for external content
  - Triggers sync INSERT/UPDATE/DELETE from memories table to FTS index
  - BM25 function returns negative scores; negate them for intuitive "higher is better" ranking
  - FTS5 query syntax can cause errors with special chars; wrap in quotes as fallback
  - Prepared statements should be cached for repeated queries (searchStmt pattern)
  - rebuildIndex() is useful after bulk imports or corruption recovery
---

## 2026-01-31 - US-003
- What was implemented: Created SQLite database wrapper with full schema initialization
- Files changed:
  - extensions/memory-tiered/db/sqlite.ts (new)
  - extensions/memory-tiered/package.json (added better-sqlite3)
  - extensions/memory-tiered/package-lock.json (new)
- **Learnings for future iterations:**
  - better-sqlite3 requires native compilation; works best with Node.js 18+
  - SQLite CHECK constraints enforce tier values at DB level: CHECK (tier IN ('HOT', 'WARM', 'COLD', 'ARCHIVE'))
  - Schema includes nullable columns entity_refs and meta_type for Phase 2 extensions
  - The Database class initializes schema in constructor - call once per db path
  - WAL mode provides better concurrency for read-heavy workloads
---

## 2026-01-31 - US-002
- What was implemented: Created core/types.ts with all type definitions for the tiered memory system
- Files changed:
  - extensions/memory-tiered/core/types.ts (new)
- **Learnings for future iterations:**
  - The project uses TypeScript with strict mode and NodeNext module resolution
  - Tier enum values should match the CHECK constraint in the future SQLite schema
  - MemoryType affects decay half-life: procedural (180d), factual (90d), project (45d), episodic (10d)
  - use_days is a string[] (JSON array) stored as string in SQLite for tracking distinct access days
---
