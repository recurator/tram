## Codebase Patterns
- Use TypeScript enums with string values for database column values (e.g., Tier.HOT = "HOT")
- Use ISO 8601 date strings for all timestamp fields
- Use JSDoc comments on interfaces and enums to document purpose and half-lives
- JSON arrays stored as strings in SQLite (e.g., use_days)

- Use better-sqlite3 for synchronous SQLite operations with TypeScript
- Enable WAL mode (journal_mode = WAL) for concurrency
- Use INTEGER for boolean columns (do_not_inject, pinned) with 0/1 values
- Foreign key constraints supported but need PRAGMA foreign_keys = ON for enforcement

- FTS5 uses content='' with content_rowid for external content tables (sync via triggers)
- BM25 scores in FTS5 are negative; negate for intuitive ranking (higher = more relevant)
- Cache prepared statements for performance (e.g., searchStmt in FTS5Helper)
- Handle FTS5 query syntax errors by falling back to phrase search with escaped quotes

---

## 2026-01-31 - US-005
- What was implemented: Created EmbeddingProvider interface for embedding abstraction
- Files changed:
  - extensions/memory-tiered/embeddings/provider.ts (new)
- **Learnings for future iterations:**
  - The EmbeddingProvider interface supports both single and batch embedding operations
  - getDimensions() returns the vector size (e.g., 384 for MiniLM, 1536 for OpenAI)
  - getModelName() returns the model identifier for logging/debugging
  - Implementations will need to cache loaded models for performance (US-006)
---

## 2026-01-31 - US-004
- What was implemented: Created FTS5 full-text search integration with BM25 ranking
- Files changed:
  - extensions/memory-tiered/db/fts.ts (new)
- **Learnings for future iterations:**
  - FTS5 virtual table uses `content='memories', content_rowid='rowid'` for external content
  - Triggers sync INSERT/UPDATE/DELETE from memories table to FTS index
  - BM25 function returns negative scores; negate them for intuitive "higher is better" ranking
  - FTS5 query syntax can cause errors with special chars; wrap in quotes as fallback
  - Prepared statements should be cached for repeated queries (searchStmt pattern)
  - rebuildIndex() is useful after bulk imports or corruption recovery
---

## 2026-01-31 - US-003
- What was implemented: Created SQLite database wrapper with full schema initialization
- Files changed:
  - extensions/memory-tiered/db/sqlite.ts (new)
  - extensions/memory-tiered/package.json (added better-sqlite3)
  - extensions/memory-tiered/package-lock.json (new)
- **Learnings for future iterations:**
  - better-sqlite3 requires native compilation; works best with Node.js 18+
  - SQLite CHECK constraints enforce tier values at DB level: CHECK (tier IN ('HOT', 'WARM', 'COLD', 'ARCHIVE'))
  - Schema includes nullable columns entity_refs and meta_type for Phase 2 extensions
  - The Database class initializes schema in constructor - call once per db path
  - WAL mode provides better concurrency for read-heavy workloads
---

## 2026-01-31 - US-002
- What was implemented: Created core/types.ts with all type definitions for the tiered memory system
- Files changed:
  - extensions/memory-tiered/core/types.ts (new)
- **Learnings for future iterations:**
  - The project uses TypeScript with strict mode and NodeNext module resolution
  - Tier enum values should match the CHECK constraint in the future SQLite schema
  - MemoryType affects decay half-life: procedural (180d), factual (90d), project (45d), episodic (10d)
  - use_days is a string[] (JSON array) stored as string in SQLite for tracking distinct access days
---
